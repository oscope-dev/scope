name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: gusto-ubuntu-default
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Calculate version
        id: version
        run: |
          VERSION=$(date -u +%Y.%m.%d.%H%M)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Merge to release branch and tag
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"

          # Checkout or create release branch
          if git fetch origin release:release 2>/dev/null; then
            git checkout release
          else
            git checkout -b release
          fi

          # Merge main into release (no commit yet)
          git merge main --no-commit --no-ff

          # Update version in Cargo.toml
          sed -i 's/^version = "0.0.0-dev"/version = "'"${VERSION}"'"/' Cargo.toml
          grep -q "^version = \"${VERSION}\"" Cargo.toml || { echo "Version update failed"; exit 1; }

          # Commit merge with version bump
          git add Cargo.toml
          git commit -m "Release v${VERSION}"

          # Create tag
          git tag "v${VERSION}"

          # Push release branch and tag
          git push origin release --force-with-lease
          git push origin "v${VERSION}"

  build:
    name: Build ${{ matrix.target }}
    needs: prepare-release
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: gusto-osx-default
            use-cross: false
          - target: x86_64-unknown-linux-gnu
            runner: gusto-ubuntu-default
            use-cross: true
          - target: x86_64-unknown-linux-musl
            runner: gusto-ubuntu-default
            use-cross: true
          - target: aarch64-unknown-linux-gnu
            runner: gusto-ubuntu-default
            use-cross: true
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release

      - name: Install Rust
        run: rustup update stable && rustup default stable

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build with cross
        if: matrix.use-cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Add Rust target
        if: ${{ !matrix.use-cross }}
        run: rustup target add ${{ matrix.target }}

      - name: Build with cargo
        if: ${{ !matrix.use-cross }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create tarball
        run: |
          set -euo pipefail
          mkdir -p dist
          cp target/${{ matrix.target }}/release/scope dist/
          cp target/${{ matrix.target }}/release/scope-intercept dist/
          tar -czvf dev-scope-${{ matrix.target }}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-scope-${{ matrix.target }}
          path: dev-scope-${{ matrix.target }}.tar.gz

  release:
    name: Create GitHub Release
    needs: [prepare-release, build]
    runs-on: gusto-ubuntu-default
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare-release.outputs.version }}"
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "" \
            artifacts/*.tar.gz
